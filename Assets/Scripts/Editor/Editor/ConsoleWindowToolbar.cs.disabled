using System;
using System.Reflection;
using UnityEditor;
using UnityEngine;
using UnityEngine.UIElements;
using Utility;

/// <summary>
/// åœ¨Consoleçª—å£æ·»åŠ å¯¼å‡ºæŒ‰é’® - åˆ›å»ºç‹¬ç«‹å·¥å…·æ ä¸å½±å“åŸæœ‰å·¥å…·æ 
/// </summary>
[InitializeOnLoad]
public static class ConsoleWindowToolbar
{
    private static Type consoleWindowType;
    private static EditorWindow consoleWindow;
    private static bool initialized = false;

    static ConsoleWindowToolbar()
    {
        consoleWindowType = Type.GetType("UnityEditor.ConsoleWindow,UnityEditor");
        EditorApplication.update += Initialize;
        EditorApplication.quitting += Cleanup;
    }

    private static void Cleanup()
    {
        EditorApplication.update -= Initialize;
    }

    private static void Initialize()
    {
        if (initialized)
        {
            // æ£€æŸ¥Consoleçª—å£æ˜¯å¦è¿˜å­˜åœ¨
            if (consoleWindow == null)
            {
                initialized = false;
            }
            return;
        }

        if (consoleWindowType == null)
            return;

        // æŸ¥æ‰¾Consoleçª—å£
        var windows = Resources.FindObjectsOfTypeAll(consoleWindowType);
        if (windows == null || windows.Length == 0)
            return;

        consoleWindow = windows[0] as EditorWindow;
        if (consoleWindow == null)
            return;

        try
        {
            var rootVisualElement = consoleWindow.rootVisualElement;
            if (rootVisualElement == null)
                return;

            // æ·»åŠ ç‹¬ç«‹å·¥å…·æ 
            if (TryAddIndependentToolbar(rootVisualElement))
            {
                initialized = true;
                Debug.Log("<color=green>âœ“ Consoleå¯¼å‡ºæŒ‰é’®å·²æ·»åŠ </color>");
            }
        }
        catch (Exception ex)
        {
            Debug.LogError($"æ·»åŠ Consoleå¯¼å‡ºæŒ‰é’®å¤±è´¥: {ex.Message}");
        }
    }

    private static bool TryAddIndependentToolbar(VisualElement root)
    {
        // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
        if (root.Q("ConsoleExportToolbar") != null)
            return true;

        // åˆ›å»ºç‹¬ç«‹çš„å·¥å…·æ å®¹å™¨ï¼Œæ”¾åœ¨æœ€é¡¶éƒ¨ï¼Œä¸å½±å“åŸæœ‰å†…å®¹
        var container = new VisualElement
        {
            name = "ConsoleExportToolbar",
            style =
            {
                flexDirection = FlexDirection.Row,
                height = 22,
                paddingTop = 2,
                paddingBottom = 2,
                paddingLeft = 8,
                paddingRight = 8,
                backgroundColor = new Color(0.25f, 0.25f, 0.25f),
                borderBottomWidth = 1,
                borderBottomColor = new Color(0.1f, 0.1f, 0.1f),
                alignItems = Align.Center
            }
        };

        // æ·»åŠ å¯¼å‡ºæŒ‰é’®
        var exportButton = new Button(() => ConsoleLogExporter.ExportEditorConsoleLog())
        {
            name = "ConsoleExportButton",
            text = "ğŸ“„ å¯¼å‡ºJSON",
            tooltip = "ä¸€é”®å¯¼å‡ºConsoleæ—¥å¿—ä¸ºJSONæ ¼å¼\næ–‡ä»¶è·¯å¾„è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªåˆ‡æ¿\n\nå¿«æ·é”®: Alt+L"
        };

        // è®¾ç½®æŒ‰é’®æ ·å¼
        exportButton.style.height = 18;
        exportButton.style.unityTextAlign = TextAnchor.MiddleCenter;
        exportButton.style.paddingLeft = 10;
        exportButton.style.paddingRight = 10;
        exportButton.style.fontSize = 11;

        container.Add(exportButton);

        // æ·»åŠ æç¤ºæ–‡æœ¬
        var hint = new Label("(è·¯å¾„è‡ªåŠ¨å¤åˆ¶)")
        {
            style =
            {
                fontSize = 10,
                marginLeft = 8,
                color = new Color(0.7f, 0.7f, 0.7f),
                unityTextAlign = TextAnchor.MiddleLeft
            }
        };
        container.Add(hint);

        // æ’å…¥åˆ°æ ¹å…ƒç´ çš„æœ€å‰é¢ï¼Œè¿™æ ·ä¸ä¼šå½±å“åŸæœ‰çš„Consoleå·¥å…·æ 
        root.Insert(0, container);

        return true;
    }
}

[
    {
        "需求名":  "修复CheckPlayerCreatByFirst未校验Token导致未授权信息泄露",
        "需求提出时间":  "2026-02-16 19:27:18",
        "需求内容":  "### Bug描述\n**位置:** 服务端 `/api/player/check-first`（HTTP）\n**严重性:** 中\n\n### 问题详情\n`/api/player/check-first` 当前未对 `token` 做有效校验。即使传入错误 token，也会返回 `success=true` 及玩家首创状态（`firstCreat`）。\n\n### 复现步骤\n1. 以任意值调用 `/api/player/check-first`，请求示例：`{ \"playerId\": \"UPgCmpna6seyUOJFkbo+Fw==\", \"token\": \"TotallyWrongToken\", \"data\": {} }`。\n2. 服务端返回 HTTP 200，响应体 `success=true`，`message=\"欢迎回来!\"`，`data.firstCreat=false`。\n3. 对比同一服务的 `/api/data/get`：错误 token 返回 HTTP 401，说明其他数据接口具备鉴权而本接口缺失。\n\n### 影响范围\n- 未授权请求可探测玩家存在性与初始化状态（信息泄露）。\n- 客户端首创流程可被伪造调用，增加状态判断混乱风险。\n\n### 期望行为\n- `/api/player/check-first` 与 `/api/data/get`、`/api/data/set` 保持一致，必须校验 token 与 playerId 绑定关系。\n\n### 建议修复方案\n1. 在 `check-first` 入口统一走 `SessionManager.ValidateSession(playerId, token)`。\n2. 校验失败返回 HTTP 401 与明确错误信息。\n3. 增加自动化回归用例：错误 token 调用 `check-first` 必须失败。",
        "需求是否完成":  false,
        "解决方案":  ""
    },
    {
        "需求名":  "check-first 未校验空白PlayerId导致写入脏键 player: ",
        "需求提出时间":  "2026-02-16 19:36:23",
        "需求内容":  "### Bug描述\n**位置:** 服务端 `HttpServer.cs:92` + `GameServer.cs:1763`\n**严重性:** 高\n\n### 问题详情\n`/api/player/check-first` 被排除在 Token 验证外，同时 `HandleCheckFirstHttp` 未校验 `playerId` 是否为空或仅空白字符，直接执行：\n- `playerKey = $\"player:{playerId}\"`\n- `_storage.HashSet(playerKey, \"name\"|\"company\"|\"createTime\", ...)`\n\n这会把非法键写入持久化文件，例如 `\"player:\"`、`\"player: \"`，污染玩家索引数据。\n\n### 功能测试记录（2026-02-16）\n1. 正常链路验证通过：\n   - `POST /api/player/join` 成功（token长度 44）\n   - `POST /api/data/set` 成功\n   - `POST /api/data/get` 成功（`message=获取成功`，返回建筑JSON长度 140）\n2. 异常链路复现：\n   - 请求：`POST /api/player/check-first`，`playerId=\" \"`（单空格），`token=\"WrongToken\"`\n   - 响应：`success=true`，`message=\"欢迎新玩家!\"`，`data.firstCreat=true`\n   - 落盘结果：`hash_data.json` 出现键 `\"player: \"`\n\n### 证据\n- 代码：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\Servc\\HttpServer.cs:92`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\Servc\\GameServer.cs:1763`\n- 日志：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_192119.txt:261`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_192119.txt:275`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_192119.txt:289`\n- 数据文件：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Data\\hash_data.json:26`\n\n### 期望行为\n1. `/api/player/check-first` 至少要校验 `playerId` 非空且非空白。\n2. 校验失败应返回 `400`（参数错误）或 `401`（鉴权失败），并禁止写库。\n3. 禁止生成 `player:`、`player: ` 这类无效键。",
        "需求是否完成":  false,
        "解决方案":  ""
    },
    {
        "需求名":  "功能测试复验：check-first 未鉴权且允许制表符PlayerId写入脏键",
        "需求提出时间":  "2026-02-16 19:47:30",
        "需求内容":  "### Bug描述\n**位置:** 服务端 `HttpServer.cs:99` 与 `GameServer.cs:1776-1787`\n**严重性:** 高\n\n### 问题详情\n本次功能测试复验确认 `/api/player/check-first` 仍存在两项问题：\n1. 接口被排除在 Token 验证之外（错误 token 也可成功返回）。\n2. `playerId` 未做空白过滤，传入制表符（`\"\\t\"`）会被拼成 `player:\\t` 并写入持久化。\n\n### 功能测试记录（2026-02-16 19:46）\n1. 正常链路（通过）：\n   - `POST /api/player/join` -\u003e `success=true`，`token` 长度 44\n   - `POST /api/data/set`（`jsonDicKey=AgentTest_20260216_194627`, `jsonDoubleKey=block`）-\u003e `success=true`\n   - `POST /api/data/get` -\u003e `message=获取成功`，返回建筑 JSON 长度 132\n2. 异常链路A（失败，存在漏洞）：\n   - 请求：`POST /api/player/check-first`，`playerId=AgentTest_20260216_194627`，`token=WrongToken`\n   - 响应：HTTP 200，`success=true`，`message=欢迎新玩家!`\n3. 异常链路B（失败，存在脏数据写入）：\n   - 请求：`POST /api/player/check-first`，`playerId=\"\\t\"`，`token=WrongToken`\n   - 响应：HTTP 200，`success=true`，`message=欢迎新玩家!`，`data.jsonDicKey=\"\\t\"`\n   - 落盘：`hash_data.json` 出现 `\"player:\\t\"` 键\n\n### 证据\n- 代码：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\Servc\\HttpServer.cs:99`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\Servc\\GameServer.cs:1776`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\Servc\\GameServer.cs:1785`\n- 日志：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_192119.txt:371`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_192119.txt:403`\n- 数据文件：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Data\\hash_data.json:44`\n\n### 期望行为\n1. `/api/player/check-first` 与其他数据接口一致，必须校验 `token`。\n2. `playerId` 必须做 `IsNullOrWhiteSpace` 校验，空白值直接拒绝。\n3. 对非法 `playerId` 返回 `400/401`，并禁止任何写库行为。",
        "需求是否完成":  false,
        "解决方案":  ""
    },
    {
        "需求名":  "功能测试复现：check-first跳过鉴权且接受空白PlayerId写入脏键",
        "需求提出时间":  "2026-02-16 19:56:29",
        "需求内容":  "### Bug描述\n位置: 服务端 HttpServer.cs:99、GameServer.cs:1787-1798\n严重性: 高\n\n### 问题详情\n本次功能测试（2026-02-16 19:55）确认 /api/player/check-first 仍然跳过 Token 校验，并且接受空白 playerId。这会导致：\n1. 错误 token 依然返回 success=true。\n2. 空白 playerId 被拼成 player:  写入 Hash 持久化，污染玩家索引数据。\n\n### 功能测试记录（实测）\n1. 正常链路（通过）\n   - POST /api/player/join -\u003e success=true，tokenLength=44\n   - POST /api/data/set（jsonDicKey=AgentLiveTest_20260216_195514, jsonDoubleKey=block）-\u003e success=true\n   - POST /api/data/get -\u003e success=true，message=获取成功，jsonValueLength=131\n2. 异常链路A（失败，存在漏洞）\n   - 请求：POST /api/player/check-first，playerId=AgentLiveTest_20260216_195514，token=WrongToken_OnlyForTest\n   - 响应：success=true，message=欢迎新玩家!\n3. 异常链路B（失败，存在脏数据写入）\n   - 请求：POST /api/player/check-first，playerId=\"  \"（两个空格），token=WrongToken_OnlyForTest\n   - 响应：success=true，message=欢迎新玩家!，data.jsonDicKey=\"  \"\n   - 服务端日志写入：Key: player:  （已写入 name/company/createTime）\n\n### 证据\n- 代码:\n  - C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\Servc\\HttpServer.cs:99\n  - C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\Servc\\GameServer.cs:1787\n  - C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\Servc\\GameServer.cs:1796\n- 日志:\n  - C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_194701.txt:205\n  - C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_194701.txt:220\n  - C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_194701.txt:235\n\n### 期望行为\n1. /api/player/check-first 必须与 /api/data/get、/api/data/set 一样校验 token。\n2. playerId 必须做 IsNullOrWhiteSpace 校验，非法值返回 400/401。\n3. 禁止写入 player:、player: 、player:\\t 等脏键。",
        "需求是否完成":  false,
        "解决方案":  ""
    },
    {
        "需求名":  "功能测试复验（20:25）：check-first 错误Token仍成功且空白PlayerId继续写入脏键",
        "需求提出时间":  "2026-02-16 20:25:20",
        "需求内容":  "### Bug描述\n位置: 服务端 `/api/player/check-first`（HTTP）\n严重性: 高\n\n### 问题详情\n本轮功能测试复验确认问题仍未修复：\n1. `check-first` 对错误 `token` 仍返回 `success=true`。\n2. `check-first` 对空白 `playerId`（本次用例：3个空格）仍会写入持久化，生成脏键 `player:   `。\n\n### 功能测试记录（2026-02-16 20:25）\n1. 正常链路（通过）\n   - `POST /api/player/join` -\u003e `success=true`, token长度=44\n   - `POST /api/data/set`（`jsonDicKey=FuncTestUser_20260216_RT3`, `jsonDoubleKey=block`）-\u003e `success=true`\n   - `POST /api/data/get`（首次）-\u003e `message=获取成功`, `jsonValueLength=139`\n   - `POST /api/player/remove` 后再次 `join` + `get` -\u003e `message=获取成功`, `jsonValueLength=139`\n   - 首次读取与重登读取 JSON 一致，且与保存 payload 一致。\n2. 异常链路A（失败，存在漏洞）\n   - 请求：`POST /api/player/check-first`，`playerId=FuncTestUser_20260216_RT3`，`token=WrongToken_For_Test`\n   - 响应：`success=true`，`message=欢迎新玩家!`\n3. 异常链路B（失败，存在脏数据写入）\n   - 请求：`POST /api/player/check-first`，`playerId=\"   \"`（3个空格），`token=WrongToken_For_Test`\n   - 响应：`success=true`，`message=欢迎新玩家!`，`data.jsonDicKey=\"   \"`\n   - 落盘：`hash_data.json` 新增 `\"player:   \"`，`createTime=2026-02-16 20:25:16`\n\n### 证据\n- 功能链路日志：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_202058.txt:121`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_202058.txt:129`\n- 脏键写入日志：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_202058.txt:178`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_202058.txt:193`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_202058.txt:207`\n- 数据文件：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Data\\hash_data.json`（存在键 `player:   `）\n\n### 期望行为\n1. `/api/player/check-first` 必须校验 `token`，错误 token 返回 401。\n2. `playerId` 必须 `IsNullOrWhiteSpace` 拒绝，非法值返回 400/401。\n3. 禁止写入 `player:`、`player: `、`player:   `、`player:\\t` 等脏键。",
        "需求是否完成":  false,
        "解决方案":  ""
    },
    {
        "需求名":  "功能测试复验（20:44）：check-first 错误Token仍成功且空白PlayerId未被拒绝",
        "需求提出时间":  "2026-02-16 20:44:22",
        "需求内容":  "### Bug描述\n位置: 服务端 `/api/player/check-first`（HTTP）\n严重性: 高\n\n### 问题详情\n本次功能测试复验（2026-02-16 20:44）确认问题仍未修复：\n1. `check-first` 对错误 `token` 仍返回 `success=true`。\n2. `check-first` 对空白 `playerId`（本次用例：3个空格）仍返回成功，并回传 `data.jsonDicKey=\"   \"`。\n3. 服务端日志加载阶段仍可见历史脏键（`player:`、`player: `、`player:   `、`player:\\t`），说明非法ID写入链路仍存在风险。\n\n### 功能测试记录（2026-02-16 20:44）\n1. 正常链路（通过）\n   - `POST /api/player/join` -\u003e `success=true`\n   - `POST /api/data/set`（`jsonDicKey=FuncTestUser_20260216_204420_AI`, `jsonDoubleKey=block`）-\u003e `success=true`\n   - `POST /api/data/get`（首次）-\u003e `message=获取成功`, `jsonValueLength=180`\n   - `POST /api/player/remove` 后再次 `join` + `get` -\u003e `message=获取成功`, `jsonValueLength=180`\n   - 首次读取与重登读取 JSON 一致，且与保存 payload 一致。\n2. 异常链路A（失败，存在漏洞）\n   - 请求：`POST /api/player/check-first`，`playerId=FuncTestUser_20260216_204420_AI`，`token=WrongToken_For_Test`\n   - 响应：`success=true`，`message=欢迎新玩家!`\n3. 异常链路B（失败，存在漏洞）\n   - 请求：`POST /api/player/check-first`，`playerId=\"   \"`（3个空格），`token=WrongToken_For_Test`\n   - 响应：`success=true`，`message=欢迎回来!`，`data.jsonDicKey=\"   \"`\n\n### 证据\n- 本次实测响应（终端）：\n  - `checkFirstWrongTokenResponse.success = true`\n  - `checkFirstWrongTokenResponse.message = 欢迎新玩家!`\n  - `checkFirstBlankUserIdentifierResponse.success = true`\n  - `checkFirstBlankUserIdentifierResponse.data.jsonDicKey = \"   \"`\n- 本次服务端日志（脏键仍存在）：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_204421.txt:26`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_204421.txt:27`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_204421.txt:36`\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Logs\\GameServer_Detail_20260216_204421.txt:39`\n\n### 期望行为\n1. `/api/player/check-first` 必须校验 `token`，错误 token 返回 401。\n2. `playerId` 必须做 `IsNullOrWhiteSpace` 校验，非法值返回 400/401。\n3. 禁止写入 `player:`、`player: `、`player:   `、`player:\\t` 等脏键。\n- 数据文件（当前落盘仍有脏键）：\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Data\\hash_data.json:33`（`\"player:\"`）\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Data\\hash_data.json:38`（`\"player: \"`）\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Data\\hash_data.json:70`（`\"player:   \"`）\n  - `C:\\Users\\Nie\\Desktop\\GameCompanyServer\\World Server\\bin\\Debug\\Data\\hash_data.json:75`（`\"player:\\t\"`）",
        "需求是否完成":  false,
        "解决方案":  ""
    }
]
